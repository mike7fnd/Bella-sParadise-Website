<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Profile – Bella’s Paradise</title>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700&family=Playfair+Display:wght@600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f7f7f7;
      --text: #222222;
      --text-light: #717171;
      --muted: #e4bdd1;
      --accent: #e6a8ce;
      --white: #ffffff;
      --radius: 12px;
      --shadow: 0 1px 3px rgba(0,0,0,0.1);
      --max-width: 1100px;
      --border: #e8e8e8;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Archivo", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding-bottom: 80px;
    }
    a { text-decoration: none; color: inherit; }

    .container { max-width: var(--max-width); margin: 0 auto; padding: 0 24px; }

    .header { padding: 32px 0 16px; border-bottom: 1px solid var(--border); margin-bottom: 40px; }
    .back-link { display: inline-flex; align-items: center; gap: 8px; color: var(--text-light); font-size: 14px; font-weight: 500; margin-bottom: 16px; }
    .back-link svg { width: 16px; height: 16px; }
    .page-title { font-size: 40px; font-weight: 500; margin-bottom: 8px; }
    .page-subtitle { color: var(--text-light); font-size: 16px; }

    .main-grid { display: grid; grid-template-columns: 1fr 300px; gap: 48px; margin-bottom: 64px; }
    .profile-section { background: var(--white); border: 1px solid var(--border); border-radius: 30px; padding: 40px; box-shadow: var(--shadow); }
    .profile-header { text-align: center; margin-bottom: 32px; }
    .avatar {
      width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
      border: 4px solid var(--white); box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      cursor: pointer; transition: all 0.2s;
    }
    .avatar:hover { transform: scale(1.05); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
    .name { font-size: 28px; font-weight: 600; margin: 20px 0 8px; }
    .role { color: var(--accent); font-weight: 600; font-size: 16px; }

    .details-grid { display: grid; grid-template-columns: max-content 1fr; gap: 16px 24px; font-size: 16px; margin: 32px 0; }
    .label { color: var(--text-light); font-weight: 500; }
    .value { font-weight: 500; }

    .actions { display: flex; gap: 12px; margin-top: 32px; flex-wrap: wrap; }
    .btn { padding: 12px 24px; border-radius: 30px; font-weight: 500; font-size: 15px; cursor: pointer; transition: all 0.2s; border: none; }
    .btn-primary { background: var(--text); color: white; }
    .btn-primary:hover { background: #e03d8f; }
    .btn-outline { border: 1.5px solid var(--text); background: transparent; color: var(--text); }
    .btn-outline:hover { background: var(--text); color: white; }

    .qr-sidebar { background: var(--white); border: 1px solid var(--border); border-radius: 30px; padding: 32px; text-align: center; height: fit-content; box-shadow: var(--shadow); }
    .qr-sidebar h3 { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
    .qr-sidebar img { width: 180px; height: 180px; border-radius: 12px; border: 1px solid var(--border); margin: 0 auto 16px; }
    .qr-sidebar p { color: var(--text-light); font-size: 14px; }

    .section { margin-bottom: 64px; }
    .section-title { font-size: 22px; font-weight: 700; margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .card { background: var(--white); border: 1px solid var(--border); border-radius: 30px; padding: 24px; transition: all 0.2s; }
    .card:hover { box-shadow: 0 8px 25px rgba(0,0,0,0.1); transform: translateY(-2px); }
    .card-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .card-subtitle { color: var(--text-light); font-size: 15px; line-height: 1.5; }
    .progress-bar { margin: 16px 0 12px; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.6s ease; }

    footer { text-align: center; padding: 40px 0; color: var(--text-light); font-size: 14px; border-top: 1px solid var(--border); }

    @media (max-width: 968px) { .main-grid { grid-template-columns: 1fr; gap: 32px; } .qr-sidebar { order: -1; } }
    @media (max-width: 640px) { .container { padding: 0 16px; } .profile-section { padding: 24px; } .actions { flex-direction: column; } .btn { width: 100%; } }
  </style>
</head>
<body>

  <div class="container">

    <!-- Header -->
    <div class="header">
      <a href="/home" class="back-link">
        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
        Back to Home
      </a>
      <h1 class="page-title">My Profile</h1>
      <p class="page-subtitle">Manage your preferences, privacy, and account settings.</p>
    </div>

    <!-- Main Content -->
    <div class="main-grid">

      <!-- Profile Card -->
      <div class="profile-section">
        <div class="profile-header">
          <img src="{{#if user.profile_picture}}{{user.profile_picture}}{{else}}https://i.pinimg.com/736x/d2/98/4e/d2984ec4b65a8568eab3dc2b640fc58e.jpg{{/if}}"
               alt="{{user.first_name}} {{user.last_name}}" class="avatar" id="profileAvatar">
          <h2 class="name">{{user.first_name}} {{user.last_name}}</h2>
        </div>

        <div class="details-grid">
          <div class="label">Email</div>
          <div class="value">{{user.email}}</div>
          <div class="label">Phone</div>
          <div class="value">{{user.mobile}}</div>
          <div class="label">Address</div>
          <div class="value">
            {{#if user.street}}{{user.street}}, {{/if}}
            {{user.barangay}}, {{user.city}},<br>
            {{user.province}}, Philippines
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-primary">Edit Profile</button>
          <button class="btn btn-outline">My Bookings</button>
        </div>
      </div>

      <!-- QR Code Sidebar -->
      <div class="qr-sidebar">
        <h3>My QR Code</h3>
        <img src="{{qrCode}}" alt="User QR Code">
        <p>Scan to view my information</p>
      </div>
    </div>

    <!-- Upcoming Stays -->
    <div class="section">
      <h2 class="section-title">Upcoming Stays</h2>
      {{#if bookings}}
        <div class="cards-grid">
          {{#each bookings}}
          <div class="card">
            <div class="card-title">{{this.facilityName}}</div>
            <div class="card-subtitle">
              Check-in: {{this.check_in}}<br>
              Check-out: {{this.check_out}} • {{this.amount}}
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: {{this.progress}}%"></div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
              <small style="color:var(--text-light);">{{this.statusLabel}}</small>
              <small style="font-weight:600; color:var(--text-light);">BKP{{this.id}}</small>
            </div>
          </div>
          {{/each}}
        </div>
      {{else}}
        <div class="card">
          <div class="card-title">No upcoming bookings</div>
          <div class="card-subtitle">You currently have no bookings. Book a stay to see your booking progress here.</div>
        </div>
      {{/if}}
    </div>

    <!-- PROFILE PICTURE MODAL (FIXED & WORKING) -->
    <div class="profile-modal" id="profileModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); backdrop-filter:blur(12px); place-items:center; z-index:1000; padding:20px;">
      <div class="modal-content" style="background:white; border-radius:24px; max-width:500px; width:100%; padding:40px 32px; box-shadow:0 30px 70px rgba(0,0,0,0.2); position:relative; text-align:center;">

        <button id="closeModal" style="position:absolute; top:16px; right:16px; width:48px; height:48px; background:rgba(255,255,255,0.95); border:none; border-radius:50%; font-size:28px; cursor:pointer; box-shadow:0 4px 15px rgba(0,0,0,0.15);">
          ×
        </button>

        <h2 style="font-size:26px; font-weight:700; margin-bottom:32px; color:#222;">
          Change Profile Picture
        </h2>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:28px;">

          <!-- GALLERY - NOW WORKS -->
          <div id="choosePhoto" style="cursor:pointer; border-radius:18px; overflow:hidden;">
            <img src="/gallery.JPG" alt="Choose from Gallery" style="width:100%; height:180px; object-fit:cover; display:block;">
            <div style="padding:16px 12px; background:white;">
              <div style="font-weight:700; font-size:18px; color:#222;">Choose Photo</div>
              <div style="font-size:14px; color:#717171; margin-top:4px;">Select from gallery</div>
            </div>
          </div>

          <!-- CAMERA -->
          <div id="takePhoto" style="cursor:pointer; border-radius:18px; overflow:hidden;">
            <img src="/camera.JPG" alt="Take Photo" style="width:100%; height:180px; object-fit:cover; display:block;">
            <div style="padding:16px 12px; background:white;">
              <div style="font-weight:700; font-size:18px; color:#222;">Take Photo</div>
              <div style="font-size:14px; color:#717171; margin-top:4px;">Use camera</div>
            </div>
          </div>
        </div>

        <!-- Hidden file input -->
        <input type="file" id="fileInput" accept="image/*" style="display:none;">
      </div>
    </div>

<!-- COMPACT WHITE CAMERA MODAL -->
<div id="cameraModal" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,0.95); backdrop-filter:blur(12px); z-index:1001; place-items:center; padding:16px;">
  <div style="width:100%; max-width:420px; background:#fff; border-radius:28px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.18); position:relative;">

    <!-- Close button -->
    <button id="closeCameraModal" style="position:absolute; top:12px; right:12px; z-index:10; width:44px; height:44px; background:#fff; color:#333; border:none; border-radius:50%; font-size:28px; cursor:pointer; box-shadow:0 4px 16px rgba(0,0,0,0.15);">
      ×
    </button>

    <!-- Title -->
    <div style="padding:24px 24px 16px; text-align:center;">
      <h2 style="color:#1a1a1a; font-size:24px; font-weight:700; margin:0;">Take a Photo</h2>
    </div>

    <!-- Camera preview -->
    <div style="position:relative; background:#000;">
      <video id="cameraPreviewFull" autoplay playsinline
             style="width:100%; height:440px; object-fit:cover; display:block;"></video>
    </div>

    <!-- Buttons -->
    <div style="display:flex; gap:16px; padding:24px; justify-content:center; background:#fff;">
      <button id="cancelCameraFull"
              style="flex:1; padding:16px; border-radius:50px; background:transparent; color:#666; border:2px solid #ddd; font-weight:600; font-size:16px; cursor:pointer;">
        Cancel
      </button>
      <button id="capturePhotoFull"
              style="flex:1; padding:16px; border-radius:50px; background:#000; color:#fff; font-weight:700; font-size:16px; cursor:pointer;">
        Capture
      </button>
    </div>
  </div>
</div>

  </div> <!-- end .container -->

  <script>
    const modal = document.getElementById('profileModal');
    const cameraModal = document.getElementById('cameraModal');
    const profileAvatar = document.getElementById('profileAvatar');
    const closeModalBtn = document.getElementById('closeModal');
    const choosePhoto = document.getElementById('choosePhoto');
    const takePhoto = document.getElementById('takePhoto');
    const fileInput = document.getElementById('fileInput');
    const cameraPreviewFull = document.getElementById('cameraPreviewFull');
    const capturePhotoFull = document.getElementById('capturePhotoFull');
    const closeCameraModal = document.getElementById('closeCameraModal');
    const cancelCameraFull = document.getElementById('cancelCameraFull');
    let stream = null;

    // Open modal
    profileAvatar.addEventListener('click', () => {
      modal.style.display = 'grid';
    });

    // Close modal
    closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });

    // GALLERY - NOW WORKS
    choosePhoto.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        const imageData = ev.target.result;
        profileAvatar.src = imageData;
        modal.style.display = 'none';

        fetch('/profile/upload-picture', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageData })
        });
      };
      reader.readAsDataURL(file);
    });

    // TAKE PHOTO
    takePhoto.addEventListener('click', async () => {
      modal.style.display = 'none';
      cameraModal.style.display = 'grid';

      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        cameraPreviewFull.srcObject = stream;
      } catch (err) {
        alert("Camera access denied or not available");
        cameraModal.style.display = 'none';
      }
    });

    function closeCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      cameraModal.style.display = 'none';
    }
    closeCameraModal.addEventListener('click', closeCamera);
    cancelCameraFull.addEventListener('click', closeCamera);

    // CAPTURE PHOTO
    capturePhotoFull.addEventListener('click', () => {
      const canvas = document.createElement('canvas');
      canvas.width = cameraPreviewFull.videoWidth;
      canvas.height = cameraPreviewFull.videoHeight;
      canvas.getContext('2d').drawImage(cameraPreviewFull, 0, 0);

      const imageData = canvas.toDataURL('image/jpeg', 0.9);
      profileAvatar.src = imageData;

      fetch('/profile/upload-picture', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ imageData })
      });

      closeCamera();
    });
  </script>
</body>
</html>
